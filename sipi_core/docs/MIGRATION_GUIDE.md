# Migration Guide: Multi-Schema Architecture

## Overview

This guide provides step-by-step instructions for migrating to the new multi-schema architecture.

## Prerequisites

- Backup your database before starting
- Ensure all current migrations are applied
- Review the [Implementation Summary](./IMPLEMENTATION_SUMMARY.md)
- Review the [Multi-Schema Architecture Design](./MULTI_SCHEMA_ARCHITECTURE.md)

## Phase 1: Validation (Before Migration)

### 1.1 Check Current State

```bash
# Check current Alembic version
alembic current

# Verify database connection
python -c "from config import CONFIG; print(CONFIG.DATABASE_URL)"

# Check current schema
psql $DATABASE_URL -c "\dn"
```

### 1.2 Backup Database

```bash
# Create backup
pg_dump $DATABASE_URL > backup_before_multi_schema_$(date +%Y%m%d_%H%M%S).sql

# Verify backup
ls -lh backup_*.sql
```

### 1.3 Test Import Structure

```bash
# Test that new imports work
python -c "from sipi_core.models import Notaria, Municipio, AppBase, GISBase; print('âœ“ Imports OK')"

# Test base classes
python -c "from sipi_core.db.base import APP_SCHEMA, GIS_SCHEMA; print(f'APP: {APP_SCHEMA}, GIS: {GIS_SCHEMA}')"
```

## Phase 2: Generate Migration

### 2.1 Create Migration

```bash
# Generate migration with autogenerate
alembic revision --autogenerate -m "implement_multi_schema_architecture"
```

### 2.2 Review Generated Migration

Open the generated migration file in `alembic/versions/` and verify:

**Expected Changes:**

1. **Schema Creation**
   ```python
   # Should create both schemas
   op.execute("CREATE SCHEMA IF NOT EXISTS app")
   op.execute("CREATE SCHEMA IF NOT EXISTS gis")
   ```

2. **Table Creation in Correct Schemas**
   ```python
   # GIS tables
   op.create_table('comunidades_autonomas',
       ...,
       schema='gis'
   )
   
   # APP tables
   op.create_table('notarias',
       ...,
       schema='app'
   )
   ```

3. **Cross-Schema Foreign Keys**
   ```python
   # Foreign key from APP to GIS
   op.create_foreign_key(
       'fk_notarias_municipio',
       'notarias', 'municipios',
       ['municipio_id'], ['id'],
       source_schema='app',
       referent_schema='gis'
   )
   ```

### 2.3 Manual Migration Adjustments

If autogenerate doesn't handle everything, manually add:

```python
def upgrade():
    # 1. Create schemas
    op.execute("CREATE SCHEMA IF NOT EXISTS app")
    op.execute("CREATE SCHEMA IF NOT EXISTS gis")
    
    # 2. Enable PostGIS
    op.execute("CREATE EXTENSION IF NOT EXISTS postgis")
    op.execute("CREATE EXTENSION IF NOT EXISTS postgis_topology")
    
    # 3. Set search path
    op.execute("SET search_path TO app, gis, public")
    
    # 4. Create tables (autogenerated)
    # ...
    
    # 5. Migrate existing data if needed
    # op.execute("INSERT INTO gis.municipios SELECT * FROM public.municipios")

def downgrade():
    # Reverse operations
    # ...
    op.execute("DROP SCHEMA IF EXISTS gis CASCADE")
    op.execute("DROP SCHEMA IF EXISTS app CASCADE")
```

## Phase 3: Apply Migration

### 3.1 Test on Development Database

```bash
# Apply migration
alembic upgrade head

# Check for errors
echo $?  # Should be 0

# Verify schemas created
psql $DATABASE_URL -c "\dn"
# Should show: app, gis, public

# Verify tables in correct schemas
psql $DATABASE_URL -c "\dt app.*"
psql $DATABASE_URL -c "\dt gis.*"
```

### 3.2 Verify Foreign Keys

```bash
# Check cross-schema foreign keys
psql $DATABASE_URL -c "
SELECT 
    tc.table_schema, 
    tc.table_name, 
    kcu.column_name,
    ccu.table_schema AS foreign_table_schema,
    ccu.table_name AS foreign_table_name
FROM information_schema.table_constraints AS tc 
JOIN information_schema.key_column_usage AS kcu
  ON tc.constraint_name = kcu.constraint_name
JOIN information_schema.constraint_column_usage AS ccu
  ON ccu.constraint_name = tc.constraint_name
WHERE tc.constraint_type = 'FOREIGN KEY'
  AND tc.table_schema IN ('app', 'gis')
ORDER BY tc.table_schema, tc.table_name;
"
```

### 3.3 Test Queries

```python
# test_multi_schema.py
from sipi_core.db.sessions import get_session
from sipi_core.models import Notaria, Municipio

async def test_cross_schema_query():
    async with get_session() as session:
        # Query with cross-schema join
        result = await session.execute(
            select(Notaria)
            .join(Municipio)
            .where(Municipio.nombre_oficial == 'Madrid')
        )
        notarias = result.scalars().all()
        print(f"Found {len(notarias)} notarias in Madrid")

# Run test
import asyncio
asyncio.run(test_cross_schema_query())
```

## Phase 4: Update Application Code

### 4.1 Update Imports

**Old:**
```python
from sipi_core.models.actores import Notaria, Administracion
from sipi_core.models.geografia import Municipio
```

**New:**
```python
from sipi_core.models import Notaria, Administracion, Municipio
# or
from sipi_core.models.actores import Notaria, Administracion
from sipi_core.models.geografia import Municipio
```

### 4.2 Update Queries

Most queries should work without changes due to search_path, but verify:

```python
# Explicit schema references (if needed)
session.execute(text("SELECT * FROM app.notarias"))
session.execute(text("SELECT * FROM gis.municipios"))

# ORM queries work transparently
session.query(Notaria).join(Municipio).all()
```

### 4.3 Update Raw SQL

If you have raw SQL, update schema references:

**Old:**
```sql
SELECT * FROM notarias n
JOIN municipios m ON n.municipio_id = m.id
```

**New (explicit):**
```sql
SELECT * FROM app.notarias n
JOIN gis.municipios m ON n.municipio_id = m.id
```

**New (with search_path):**
```sql
SET search_path TO app, gis, public;
SELECT * FROM notarias n
JOIN municipios m ON n.municipio_id = m.id
```

## Phase 5: Validation (After Migration)

### 5.1 Data Integrity Checks

```sql
-- Check row counts match
SELECT 'app.notarias' as table, COUNT(*) FROM app.notarias
UNION ALL
SELECT 'gis.municipios', COUNT(*) FROM gis.municipios;

-- Check foreign key integrity
SELECT COUNT(*) FROM app.notarias n
LEFT JOIN gis.municipios m ON n.municipio_id = m.id
WHERE n.municipio_id IS NOT NULL AND m.id IS NULL;
-- Should return 0
```

### 5.2 Performance Checks

```sql
-- Check indexes exist
SELECT schemaname, tablename, indexname 
FROM pg_indexes 
WHERE schemaname IN ('app', 'gis')
ORDER BY schemaname, tablename;

-- Check query plans
EXPLAIN ANALYZE
SELECT * FROM app.notarias n
JOIN gis.municipios m ON n.municipio_id = m.id
WHERE m.nombre_oficial = 'Madrid';
```

### 5.3 Application Tests

```bash
# Run full test suite
pytest tests/

# Run specific integration tests
pytest tests/integration/test_actors.py
pytest tests/integration/test_geography.py
```

## Phase 6: Cleanup

### 6.1 Remove Old Files (After Verification)

```bash
# Only after everything is verified!
git rm src/sipi/db/models/actores.py
git rm src/sipi/db/models/geografia.py

# Commit changes
git add .
git commit -m "Complete multi-schema architecture migration"
```

### 6.2 Update Documentation

- Update API documentation
- Update developer guides
- Update deployment scripts
- Update CI/CD pipelines

## Rollback Procedure

If issues arise:

### Option 1: Alembic Downgrade

```bash
# Downgrade one version
alembic downgrade -1

# Or downgrade to specific version
alembic downgrade <previous_revision>
```

### Option 2: Restore from Backup

```bash
# Drop database
dropdb $DATABASE_NAME

# Recreate database
createdb $DATABASE_NAME

# Restore backup
psql $DATABASE_URL < backup_before_multi_schema_YYYYMMDD_HHMMSS.sql

# Verify restoration
psql $DATABASE_URL -c "\dt"
```

### Option 3: Revert Code Changes

```bash
# Revert to previous commit
git revert HEAD

# Or reset to previous state
git reset --hard <previous_commit>

# Reinstall dependencies
pip install -e .
```

## Troubleshooting

### Issue: Foreign Key Errors

**Symptom:** Foreign key constraint violations

**Solution:**
```sql
-- Check for orphaned records
SELECT * FROM app.notarias n
LEFT JOIN gis.municipios m ON n.municipio_id = m.id
WHERE n.municipio_id IS NOT NULL AND m.id IS NULL;

-- Fix orphaned records
UPDATE app.notarias 
SET municipio_id = NULL 
WHERE municipio_id NOT IN (SELECT id FROM gis.municipios);
```

### Issue: Schema Not Found

**Symptom:** `schema "app" does not exist`

**Solution:**
```sql
-- Create schemas manually
CREATE SCHEMA IF NOT EXISTS app;
CREATE SCHEMA IF NOT EXISTS gis;

-- Set search path
ALTER DATABASE your_database SET search_path TO app, gis, public;
```

### Issue: Import Errors

**Symptom:** `ImportError: cannot import name 'Notaria'`

**Solution:**
```bash
# Reinstall package
pip install -e .

# Clear Python cache
find . -type d -name __pycache__ -exec rm -rf {} +
find . -type f -name "*.pyc" -delete

# Verify imports
python -c "from sipi_core.models import Notaria; print('OK')"
```

### Issue: Alembic Can't Detect Changes

**Symptom:** `alembic revision --autogenerate` generates empty migration

**Solution:**
```python
# In alembic/env.py, verify:
from sipi_core.db.base import AppBase, GISBase
from sipi_core.db import models  # Import all models

# Ensure metadata is combined
combined_metadata = MetaData()
for table in AppBase.metadata.tables.values():
    table.to_metadata(combined_metadata)
for table in GISBase.metadata.tables.values():
    table.to_metadata(combined_metadata)

target_metadata = combined_metadata
```

## Post-Migration Checklist

- [ ] All migrations applied successfully
- [ ] Both schemas exist (app, gis)
- [ ] Tables in correct schemas
- [ ] Foreign keys work across schemas
- [ ] Indexes created correctly
- [ ] Search path configured
- [ ] Application tests pass
- [ ] Performance acceptable
- [ ] Documentation updated
- [ ] Team notified
- [ ] Backup verified
- [ ] Rollback plan tested

## Support

If you encounter issues:

1. Check this guide's troubleshooting section
2. Review [Implementation Summary](./IMPLEMENTATION_SUMMARY.md)
3. Check Alembic logs: `alembic history`
4. Review database logs
5. Contact the development team

## References

- [Multi-Schema Architecture Design](./MULTI_SCHEMA_ARCHITECTURE.md)
- [Implementation Summary](./IMPLEMENTATION_SUMMARY.md)
- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [PostgreSQL Schema Documentation](https://www.postgresql.org/docs/current/ddl-schemas.html)
